version: '3.8'

services:
  minio:
    image: minio/minio
    container_name: yuzu-minio
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - yuzu-network

  mailhog:
    image: mailhog/mailhog
    container_name: mailhog
    ports:
      - "1025:1025"  # SMTP port
      - "8025:8025"  # Web UI port
    networks:
      - yuzu-network

  yuzu-web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: yuzu-web
    depends_on:
      - minio
      - mailhog
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      # Replace with your actual Scaleway PostgreSQL credentials
      - DataStorageConfig__ConnectionString=Host=YOUR_SCALEWAY_POSTGRES_ENDPOINT;Database=yuzu;Username=YOUR_USERNAME;Password=YOUR_PASSWORD;SslMode=Require
      # Local MinIO for S3 storage
      - S3Settings__ServiceUrl=http://minio:9000
      - S3Settings__BucketName=static
      - S3Settings__BackgroundsContainer=backgrounds
      - S3Settings__AccessKey=minioadmin
      - S3Settings__SecretKey=minioadmin
      # Local MailHog for email testing
      - MailConnectionConfig__smtpServer=mailhog
      - MailConnectionConfig__smtpUsername=yuzu
      - MailConnectionConfig__smtpPassword=Apollo13!
      - MailConnectionConfig__smtpPort=1025
    ports:
      - "8080:80"
    networks:
      - yuzu-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Uncomment this section if you want to use Scaleway Object Storage instead of local MinIO
  # yuzu-web-with-scaleway-s3:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: yuzu-web-s3
  #   depends_on:
  #     - mailhog
  #   environment:
  #     - ASPNETCORE_ENVIRONMENT=Production
  #     # Replace with your actual Scaleway PostgreSQL credentials
  #     - DataStorageConfig__ConnectionString=Host=YOUR_SCALEWAY_POSTGRES_ENDPOINT;Database=yuzu;Username=YOUR_USERNAME;Password=YOUR_PASSWORD;SslMode=Require
  #     # Scaleway Object Storage
  #     - S3Settings__ServiceUrl=https://s3.fr-par.scw.cloud
  #     - S3Settings__BucketName=YOUR_BUCKET_NAME
  #     - S3Settings__BackgroundsContainer=backgrounds
  #     - S3Settings__AccessKey=YOUR_ACCESS_KEY
  #     - S3Settings__SecretKey=YOUR_SECRET_KEY
  #     # Local MailHog for email testing
  #     - MailConnectionConfig__smtpServer=mailhog
  #     - MailConnectionConfig__smtpUsername=yuzu
  #     - MailConnectionConfig__smtpPassword=Apollo13!
  #     - MailConnectionConfig__smtpPort=1025
  #   ports:
  #     - "8081:80"
  #   networks:
  #     - yuzu-network
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:80/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s

networks:
  yuzu-network:
    driver: bridge

volumes:
  minio-data: