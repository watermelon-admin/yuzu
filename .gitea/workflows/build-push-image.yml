name: Build and Push Image

on:
  # Manual trigger only
  workflow_dispatch:

jobs:
  build-push:
    runs-on: custom-runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version tag
        id: get_version
        run: |
          # Get short commit hash
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-8)
          
          # Get current date in ISO format for build date
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          echo "Commit hash: $SHORT_SHA"
          echo "Build date: $BUILD_DATE"
          
          # Store values for later steps
          echo "git_commit=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          
          # Get version tag as before
          if [[ ${{ github.ref_type }} == 'tag' && ${{ github.ref_name }} == v* ]]; then
            # If this is a tag push like v1.2.3, use that as version without the 'v'
            VERSION=$(echo ${{ github.ref_name }} | sed 's/^v//')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            # Otherwise use commit SHA for the version tag
            echo "version=$SHORT_SHA" >> $GITHUB_OUTPUT
          fi
        
      - name: Configure Docker Credentials
        env:
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
        run: |
          # Login to Scaleway registry
          echo "$SCW_SECRET_KEY" | docker login rg.fr-par.scw.cloud -u nologin --password-stdin
          echo "Docker login completed"

      - name: Build Docker image with version information
        run: |
          # Pass git commit and build date to Docker build
          docker build \
            --build-arg GIT_COMMIT=${{ steps.get_version.outputs.git_commit }} \
            --build-arg BUILD_DATE=${{ steps.get_version.outputs.build_date }} \
            -t yuzu:latest .

      - name: Tag Docker images
        run: |
          # Always tag with latest
          docker tag yuzu:latest rg.fr-par.scw.cloud/cr-yuzu-par-1/yuzu-web:latest
          
          # Use commit hash as the primary tag
          docker tag yuzu:latest rg.fr-par.scw.cloud/cr-yuzu-par-1/yuzu-web:${{ steps.get_version.outputs.git_commit }}
          
          # If we have a version tag, use that too
          if [ ! -z "${{ steps.get_version.outputs.version }}" ]; then
            docker tag yuzu:latest rg.fr-par.scw.cloud/cr-yuzu-par-1/yuzu-web:${{ steps.get_version.outputs.version }}
          fi

      - name: Push Docker images to registry
        env:
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
        run: |
          echo "Pushing image with tag: latest"
          docker push rg.fr-par.scw.cloud/cr-yuzu-par-1/yuzu-web:latest
          
          echo "Pushing image with tag: ${{ steps.get_version.outputs.git_commit }}"
          docker push rg.fr-par.scw.cloud/cr-yuzu-par-1/yuzu-web:${{ steps.get_version.outputs.git_commit }}
          
          # If we have a version tag, push that too
          if [ ! -z "${{ steps.get_version.outputs.version }}" ]; then
            echo "Pushing image with tag: ${{ steps.get_version.outputs.version }}"
            docker push rg.fr-par.scw.cloud/cr-yuzu-par-1/yuzu-web:${{ steps.get_version.outputs.version }}
          fi