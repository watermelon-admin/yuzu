@{
    // Configure the standardized template with container IDs matching JavaScript expectations
    ViewData["SectionId"] = "backgrounds-gallery";
    ViewData["SectionTitle"] = "Backgrounds";
    ViewData["ContainerColumns"] = "row-cols-1 row-cols-sm-2 row-cols-md-3 gx-3 gx-lg-4";
    ViewData["ShowViewport"] = true;
    
    // Conditional button based on subscription status
    if (Model.IsSubscribed)
    {
        ViewData["ActionButton"] = new Dictionary<string, string>
        {
            { "id", "backgrounds-upload-button" },
            { "icon", "bx bx-upload" },
            { "text", "Upload Background" },
            { "data-bs-toggle", "modal" },
            { "data-bs-target", "#backgrounds-upload-modal" }
        };
    }
    else
    {
        ViewData["ActionButton"] = new Dictionary<string, string>
        {
            { "id", "backgrounds-upload-button" },
            { "icon", "bx bx-upload" },
            { "text", "Upload Background" },
            { "data-bs-toggle", "modal" },
            { "data-bs-target", "#backgrounds-subscription-prompt-modal" },
            { "requiresSubscription", "true" }
        };
    }
}


@* Include the standardized template *@
<partial name="~/Pages/Settings/Shared/_StandardSectionTemplate.cshtml" />

<!-- Storage info section - divider and centered text -->
<div class="mt-3 mb-4">
    <!-- Subtle divider line -->
    <hr class="opacity-25 mb-3">
    <!-- Centered storage info text -->
    <div class="text-center">
        <p id="backgrounds-storage-info" class="text-muted fs-6 mb-0">
            Loading background storage information...
        </p>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="backgrounds-upload-modal" tabindex="-1" aria-labelledby="backgrounds-upload-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <!-- Changed from modal-dialog to modal-lg for wider dialog -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backgrounds-upload-modal-label">Upload Background Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="backgrounds-upload-form" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <!-- Added row container for side-by-side layout -->
                        <!-- Left column: Form inputs -->
                        <div class="col-md-6">
                            <div class="d-flex flex-column h-100">
                                <!-- Top aligned content (red panel) -->
                                <div class="mb-auto">
                                    <p class="mb-3">Upload a JPG or PNG image to use as a custom background.</p>
                                    <!-- Hidden anti-forgery token -->
                                    @Html.AntiForgeryToken()
                                    <!-- Title Input with validation -->
                                    <div class="mb-5">
                                        <label for="backgrounds-image-title" class="form-label fs-base">Image Title</label>
                                        <input type="text" class="form-control" id="backgrounds-image-title" name="imageTitle" maxlength="50" required
                                               placeholder="Enter a unique title for your background">
                                        <div class="form-text">This title will be displayed in your background library.</div>
                                        <div style="min-height: 40px;">
                                            <div class="fs-sm text-danger validation-message w-100" id="backgrounds-title-validation-message">
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <!-- Bottom aligned content (blue panel) -->
                                <div class="mt-auto">
                                    <!-- Information text moved here -->
                                    <div class="alert alert-info small mt-0 mb-0">
                                        <ul class="mb-0">
                                            <li>Maximum file size: 5MB</li>
                                            <li>Allowed formats: JPG, PNG</li>
                                            <li>Recommended dimensions: 1920Ã—1080px</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Right column: FilePond Image upload/preview -->
                        <div class="col-md-6">
                            <div class="h-100 d-flex flex-column">
                                <!-- File upload element fills available space -->
                                <div class="h-100">
                                    <input type="file" class="filepond h-100" name="file" id="backgrounds-file-upload"
                                           accept="image/png, image/jpeg" />
                                    <!-- Validation message at bottom -->
                                    <div style="position:relative; top: -60px; width:100%; text-align: center;">
                                        <div class="fs-sm text-danger validation-message" id="backgrounds-file-validation-message">
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>

                    <!-- Validation alert for overall form errors - full width -->
                    <div class="alert d-flex alert-danger mt-3 mb-0 d-none" role="alert" id="backgrounds-form-validation-alert">
                        <i class="bx bx-bell lead me-3"></i>
                        <div id="backgrounds-form-validation-message">
                            Please correct the errors above before uploading.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="backgrounds-modal-upload-button">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Subscription Prompt Modal -->
<div class="modal fade" id="backgrounds-subscription-prompt-modal" tabindex="-1" aria-labelledby="backgrounds-subscription-prompt-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backgrounds-subscription-prompt-modal-label">Pro Feature</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fa-solid fa-rectangle-pro fs-1 text-warning"></i>
                    <h5 class="mt-3">Custom Background Uploads</h5>
                    <p>Custom background uploading is a Premium feature that requires a Pro subscription.</p>
                </div>
                <div class="d-flex justify-content-center">
                    <a href="~/pricing" class="btn btn-primary">
                        <i class="bx bx-upgrade me-2"></i>
                        Upgrade to Pro
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="backgrounds-delete-modal" tabindex="-1" aria-labelledby="backgrounds-delete-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backgrounds-delete-modal-label">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this background image? This action cannot be undone.</p>
                <input type="hidden" id="backgrounds-delete-image-name" value="" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="backgrounds-confirm-delete-button">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Background Image Card Template -->
<template id="backgrounds-card-template">
    <div class="col pb-lg-2 mb-4">
        <article class="card settings-card h-100">
            <div class="position-relative">
                <img src="" style="border-radius: 0.5rem 0.5rem 0 0; height: 180px; object-fit: cover;" class="card-img-top" alt="Background Image">
            </div>
            <div class="card-body">
                <h3 class="h5 fw-semibold text-truncate mb-0">
                    <span class="backgrounds-card-title"></span>
                </h3>
            </div>
            <div class="card-footer d-flex align-items-center py-3">
                <div class="d-flex">
                    <button type="button" class="backgrounds-preview-button btn btn-sm btn-outline-primary me-3">
                        <i class="bx bx-search-alt fs-xl me-1"></i>
                        <span>Preview</span>
                    </button>
                    <button type="button" class="backgrounds-delete-button btn btn-sm btn-outline-danger" title="Delete">
                        <i class="bx bx-trash-alt fs-xl me-1"></i>
                        <span class="d-none d-md-inline">Delete</span>
                    </button>
                </div>
            </div>
        </article>
    </div>
</template>

<!-- Image Preview Modal -->
<div class="modal fade" id="backgrounds-preview-modal" tabindex="-1" aria-labelledby="backgrounds-preview-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backgrounds-preview-modal-label">Background Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <img id="backgrounds-preview-image" src="" class="img-fluid w-100" alt="Background Image">
            </div>
        </div>
    </div>
</div>